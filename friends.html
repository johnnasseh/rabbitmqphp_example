<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friends</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script>
        // checks for token
        window.onload = function() {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("You must be logged in to view friend requests.");
                window.location.href = "index.html"; // if not logged in redirects to login
            } else {
                fetchFriendData(); // if logged in then fetches friend data
            }
        };

        function fetchFriendData() {
            console.log("Fetching friend data...");
            const token = localStorage.getItem("token");
            if (!token) {
                alert("You must be logged in to view friend requests.");
                return;
            }

            fetch('friends_logic.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `token=${encodeURIComponent(token)}`
            })
            .then(response => response.json())
            .then(data => {
                console.log("Data received from backend:", data);
                if (data.status === 'success') {
                    console.log("Incoming Requests:", data.incomingRequests);
                    console.log("Pending Requests:", data.pendingRequests);
                    console.log("Friends List:", data.friends);
                    displayIncomingRequests(data.incomingRequests);
                    displayPendingRequests(data.pendingRequests);
                    displayFriends(data.friends);
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function displayIncomingRequests(incomingRequests) {
            console.log("Displaying incoming requests:", incomingRequests);
            const incomingList = document.getElementById('incomingRequests');
            incomingList.innerHTML = '';
            if (incomingRequests && incomingRequests.length > 0) {
                incomingRequests.forEach(request => {
                    incomingList.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                        ${request}
                        <div>
                            <button class="btn btn-success btn-sm" onclick="handleFriendRequest('${request}', 'accept')">Accept</button>
                            <button class="btn btn-danger btn-sm" onclick="handleFriendRequest('${request}', 'decline')">Decline</button>
                        </div>
                    </li>`;
                });
            } else {
                incomingList.innerHTML = '<li class="list-group-item">No incoming requests</li>';
            }
        }

        function displayPendingRequests(pendingRequests) {
            console.log("Displaying pending requests:", pendingRequests);
            const pendingList = document.getElementById('pendingRequests');
            pendingList.innerHTML = '';
            if (pendingRequests && pendingRequests.length > 0) {
                pendingRequests.forEach(request => {
                    pendingList.innerHTML += `<li class="list-group-item">${request}</li>`;
                });
            } else {
                pendingList.innerHTML = '<li class="list-group-item">No pending requests</li>';
            }
        }

        function displayFriends(friends) {
            console.log("Displaying friends list:", friends);
            const friendsList = document.getElementById('friendsList');
            friendsList.innerHTML = '';
            if (friends && friends.length > 0) {
                friends.forEach(friend => {
                    friendsList.innerHTML += `<li class="list-group-item">${friend}</li>`;
                });
            } else {
                friendsList.innerHTML = '<li class="list-group-item">You have no friends added yet</li>';
            }
        }

        function handleFriendRequest(friendUsername, action) {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("You must be logged in to perform this action.");
                return;
            }

            fetch('handle_friend_request.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `token=${encodeURIComponent(token)}&friend_username=${encodeURIComponent(friendUsername)}&action=${action}`
            })
            .then(response => response.json())
            .then(data => {
                console.log("Friend request action response:", data);
                if (data.status === "success") {
                    alert(data.message);
                    fetchFriendData(); // Refresh lists after action
                } else {
                    alert("Failed to handle request: " + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function sendFriendRequest() {
            const token = localStorage.getItem("token");
            const friendUsername = document.getElementById('searchInput').value;
            if (!token) {
                alert("You must be logged in to send friend requests.");
                return;
            }

            fetch('handle_friend_request.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `token=${encodeURIComponent(token)}&friend_username=${encodeURIComponent(friendUsername)}&action=send_request`
            })
            .then(response => response.json())
            .then(data => {
                console.log("Send friend request response:", data);
                if (data.status === 'success') {
                    alert(data.message);
                    fetchFriendData(); // refreshs lists after sending request
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</head>
<body>
    <div class="container mt-5">
        <h1>Friends</h1>

        <h2>Send Friend Request</h2>
        <div class="form-group">
            <input type="text" id="searchInput" class="form-control" placeholder="Enter username">
            <button class="btn btn-primary mt-2" onclick="sendFriendRequest()">Send Request</button>
        </div>

        <h2>Incoming Friend Requests</h2>
        <ul class="list-group" id="incomingRequests"></ul>

        <h2>Pending Friend Requests</h2>
        <ul class="list-group" id="pendingRequests"></ul>

        <h2>Friends List</h2>
        <ul class="list-group" id="friendsList"></ul>
    </div>
</body>
</html>
